# Task: Speed up tests + per-test timing table

## 0. Meta

- Date: 2025-12-30
- Agent: ü¶Ü GPT-5.2
- Branch: cursor/test-performance-optimization-15da
- PR: n/a (local workspace change)
- Related: n/a

## 1. Task

### What to do

- Speed up the repository test suite where it‚Äôs safe.
- Add a markdown table with timings per test (baseline vs current) into this task file.
- Consider merging/combining redundant installer tests by using better fixtures / shared setup.

### Definition of Done (acceptance criteria)

- `npm run test:unit` and `npm run test:installer:pw` pass.
- Total test runtime is reduced (or at least the slowest tests are improved) without reducing coverage.
- This task file contains a per-test timings table.

### Out of scope

- Changing CI pipelines / job topology.
- Making tests parallel if it risks flakiness (unless clearly safe).

## 2. Status Log

- 2025-12-30 ‚Äî Collected baseline timings (unit + Playwright) and generated a per-test table.
- 2025-12-30 ‚Äî Reduced unit runner overhead (avoid `npx`), trimmed redundant installer waits, and shared workspace for stateful ‚Äúexisting workspace‚Äù installer tests.
- 2025-12-30 ‚Äî Added a fast in-process installer runner for cursor-free installs (with safe fallback to subprocess when cursor module is enabled).
- 2025-12-30 ‚Äî Added timeouts to Cursor API probe check to avoid long hangs.

## 3. Plan

1. Collect baseline timings for unit tests (node:test) and Playwright installer tests.
2. Identify redundant waits / repeated installations in installer tests and reduce them.
3. Reduce overhead in the unit test runner (avoid `npx`).
4. Re-run tests, collect ‚Äúcurrent‚Äù timings, and generate a per-test comparison table.
5. Document changes and follow-ups.

## 4. Implementation Notes

### Key optimizations

- **Unit runner** (`src/run-tests.ts`):
  - Switched from `npx tsx ...` to using the local `node_modules/.bin/tsx` binary to reduce startup overhead.
- **Installer tests**:
  - Removed redundant `waitForInstallation(...)` calls after installer completion in unattended tests (installer completion is already synchronous with respect to filesystem outputs).
  - Converted ‚ÄúExisting Workspace Operations‚Äù in `installer-unattended.pw.spec.ts` to a **shared, serial workspace** to avoid repeating the same initial install work in multiple tests.
  - Introduced `runInstallerInProcess(...)` for **cursor-free** installer runs (no extra Node/tsx process), with a deliberate fallback to the existing subprocess runner when the **cursor** module is involved (the cursor probe uses `curl`, and synchronous child processes would block an in-process mock HTTP server).
- **Cursor API probe** (`extensions/cursor/MODULE.md`):
  - Added `curl` timeouts (`--connect-timeout 2 --max-time 5`) and made the failure path deterministic (no ‚Äú000000‚Äù double-code).

### Totals (baseline ‚Üí current)

- **Unit tests**: 17,419ms ‚Üí 15,677ms (‚âà **-1,742ms**)
- **Playwright installer suite**: 20,773ms ‚Üí 13,505ms (‚âà **-7,268ms**)

## 5. Measurements (per test)

> Table generated from:
> - Unit output: `.cache/baseline-unit.out` vs `.cache/current-unit.out`
> - Playwright JSON: `.cache/baseline-pw.json` vs `.cache/current-pw.json`
>
> Generator: `scripts/perf/print-test-timings-table.ts`

| suite | test | baseline | current | delta |
|---|---|---:|---:|---:|
| pw_installer | npx-new-workspace.pw.spec.ts > npx-new-workspace.pw.spec.ts > barducks new (npx-friendly bootstrap) > clones Barducks into barducks/src when not listed in projects | 6602.0ms | 3671.0ms | -2931.0ms |
| pw_installer | npx-new-workspace.pw.spec.ts > npx-new-workspace.pw.spec.ts > barducks new (npx-friendly bootstrap) > resolves relative workspace path from INIT_CWD (npx cache cwd simulation) | 3764.0ms | 3398.0ms | -366.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Existing Workspace Operations > Reinstall Existing Workspace - Unattended | 838.0ms | 806.0ms | -32.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > External Repository Installation > Installation with External Repository | 495.0ms | 509.0ms | +14.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Fresh Workspace Installation > Unattended Installation with workspace config template (local folder project src) | 512.0ms | 503.0ms | -9.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Fresh Workspace Installation > Unattended Installation with workspace config template seedFiles[] copies seed files/folders | 410.0ms | 439.0ms | +29.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Existing Workspace Operations > Remove Extensions from Existing Workspace | 806.0ms | 425.0ms | -381.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Existing Workspace Operations > Reinstallation Verification - Preserve Configuration | 836.0ms | 420.0ms | -416.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Fresh Workspace Installation > Unattended Installation from fixture - cursor-only | 420.0ms | 415.0ms | -5.0ms |
| pw_installer | workspace-modules-installation.pw.spec.ts > workspace-modules-installation.pw.spec.ts > Workspace Installer - Workspace-local extensions/ > Installs extension from workspace/extensions when listed in config | 429.0ms | 414.0ms | -15.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Existing Workspace Operations > Add Extensions to Existing Workspace | 839.0ms | 410.0ms | -429.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Fresh Workspace Installation > Unattended Installation - Full Structure Verification | 415.0ms | 409.0ms | -6.0ms |
| pw_installer | installer-gui.pw.spec.ts > installer-gui.pw.spec.ts > Workspace Installer - GUI/Interactive Mode > Existing Workspace Operations > Detect Existing Workspace | 440.0ms | 408.0ms | -32.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Existing Workspace Operations > Reinstallation - Extension Hooks Re-executed | 838.0ms | 408.0ms | -430.0ms |
| pw_installer | installer-gui.pw.spec.ts > installer-gui.pw.spec.ts > Workspace Installer - GUI/Interactive Mode > Fresh Workspace Installation > GUI Installation - Fresh Workspace | 495.0ms | 403.0ms | -92.0ms |
| pw_installer | installer-strictness.pw.spec.ts > installer-strictness.pw.spec.ts > installer: hook load failure is fatal | 457.0ms | 172.0ms | -285.0ms |
| pw_installer | installer-strictness.pw.spec.ts > installer-strictness.pw.spec.ts > installer: .env values are available to shell checks (fill-missing) | 379.0ms | 68.0ms | -311.0ms |
| pw_installer | installer-strictness.pw.spec.ts > installer-strictness.pw.spec.ts > installer: checks without name do not print "Checking undefined" | 397.0ms | 43.0ms | -354.0ms |
| pw_installer | installer-strictness.pw.spec.ts > installer-strictness.pw.spec.ts > installer summary: prints INSTALLATION FINISHED WITH ERRORS on failures | 400.0ms | 38.0ms | -362.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Fresh Workspace Installation > Unattended Installation with Config File | 400.0ms | 37.0ms | -363.0ms |
| pw_installer | installer-unattended.pw.spec.ts > installer-unattended.pw.spec.ts > Workspace Installer - Unattended Mode > Fresh Workspace Installation > Unattended Installation - Fresh Workspace | 392.0ms | 31.0ms | -361.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 1: Check Environment Variables | 31.0ms | 29.0ms | -2.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 5: Setup Modules | 141.0ms | 12.0ms | -129.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 4: Check Environment Again | 7.0ms | 9.0ms | +2.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 7: Verify Installation | 6.0ms | 6.0ms | 0.0ms |
| pw_installer | module-patterns.pw.spec.ts > module-patterns.pw.spec.ts > workspace extension patterns > extensions: ["issue-*"] expands to issue-tracker and issue-tracker-github | 6.0ms | 5.0ms | -1.0ms |
| pw_installer | install-project-scripts.pw.spec.ts > install-project-scripts.pw.spec.ts > Install Project Scripts > Install default scripts from project @smoke | 4.0ms | 3.0ms | -1.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 2: Download Repos | 3.0ms | 3.0ms | 0.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 3: Download Projects @smoke | 3.0ms | 3.0ms | 0.0ms |
| pw_installer | install-project-scripts.pw.spec.ts > install-project-scripts.pw.spec.ts > Install Project Scripts > Install additional scripts via importScripts @smoke | 2.0ms | 2.0ms | 0.0ms |
| pw_installer | install-project-scripts.pw.spec.ts > install-project-scripts.pw.spec.ts > Install Project Scripts > Remove scripts when project is removed from config @smoke | 2.0ms | 2.0ms | 0.0ms |
| pw_installer | install-steps.pw.spec.ts > install-steps.pw.spec.ts > Installation Steps > Step 6: Setup Projects @smoke | 2.0ms | 2.0ms | 0.0ms |
| pw_installer | install-project-scripts.pw.spec.ts > install-project-scripts.pw.spec.ts > Install Project Scripts > Handle missing project package.json gracefully @smoke | 1.0ms | 1.0ms | 0.0ms |
| pw_installer | install-project-scripts.pw.spec.ts > install-project-scripts.pw.spec.ts > Install Project Scripts > Verify scripts do not change current directory @smoke | 1.0ms | 1.0ms | 0.0ms |
| unit | launch dev starts background processes, runs smokecheck, captures browser console, and allows reuse | 6444.4ms | 5436.9ms | -1007.4ms |
| unit | workspace config launch.dev starts processes, runs smokecheck, and supports smokecheck without args | 5889.4ms | 5325.4ms | -564.0ms |
| unit | messenger CLI exposes required inputs as options | 1024.0ms | 964.9ms | -59.1ms |
| unit | ci CLI positional still works (no duplicate required flags) | 471.8ms | 477.7ms | +6.0ms |
| unit | barducks-cli sync generates .cache/taskfile.generated.yml from merged config.taskfile | 495.4ms | 448.7ms | -46.8ms |
| unit | stop kills a process group (parent + child) | 106.1ms | 119.2ms | +13.1ms |
| unit | ProcessManager writes stdout/stderr logs | 85.1ms | 93.7ms | +8.6ms |
| unit | email: provider registry discovery > discovers smogcheck-provider from modules directory and registers it | 61.5ms | 62.9ms | +1.4ms |
| unit | ci: provider registry discovery > discovers smogcheck-provider from modules directory and registers it | 86.9ms | 62.5ms | -24.4ms |
| unit | email: provider registry discovery (gmail-provider) > discovers gmail-provider from modules directory and registers it | 58.1ms | 56.5ms | -1.6ms |
| unit | issue-tracker-github: provider registry discovery > discovers github-provider from modules directory and registers it (with schema validation) | 26.9ms | 31.8ms | +5.0ms |
| unit | messenger: provider registry discovery > discovers messenger providers from modules directory and registers them (with schema validation) | 24.6ms | 29.0ms | +4.4ms |
| unit | issue-tracker: provider registry discovery > discovers smogcheck-provider from modules directory and registers it (with schema validation) | 26.4ms | 26.2ms | -0.2ms |
| unit | mcp: API module > mcp module is included in unified API | 22.4ms | 20.9ms | -1.5ms |
| unit | install/mcp optional servers > marks optional URL-based server failure as non-blocking | 13.3ms | 13.4ms | +0.1ms |
| unit | workspace.config.yml supports extends (barducks:) with concat+dedupe merge | 11.9ms | 12.1ms | +0.2ms |
| unit | install/mcp optional servers > marks optional command-based server failure as non-blocking | 5.6ms | 5.7ms | +0.2ms |
| unit | issue-tracker: smogcheck-provider > downloadResources creates issue.json with comments and PRs | 0.9ms | 2.3ms | +1.4ms |
| unit | issue-tracker: smogcheck-provider > downloadResources creates correct directory structure | 2.0ms | 2.2ms | +0.1ms |
| unit | extends cycle is detected and reported | 2.2ms | 1.9ms | -0.2ms |
| unit | messenger: telegram-provider > getChatHistory returns messages that match ChatMessage schema | 1.4ms | 1.9ms | +0.5ms |
| unit | email: smogcheck-provider > listUnreadMessages returns messages that match Message schema | 1.6ms | 1.7ms | +0.1ms |
| unit | messenger: yandex-messenger-provider > getChatHistory returns messages that match ChatMessage schema | 1.3ms | 1.6ms | +0.3ms |
| unit | issue-tracker: smogcheck-provider > matches IssueTrackerProvider contract schema | 1.5ms | 1.6ms | +0.1ms |
| unit | issue-tracker-github: github-provider > matches IssueTrackerProvider contract schema | 1.5ms | 1.6ms | +0.1ms |
| unit | ci: smogcheck-provider > matches CIProvider interface | 0.6ms | 1.5ms | +1.0ms |
| unit | messenger: telegram-provider > matches MessengerProvider contract schema | 1.4ms | 1.5ms | +0.1ms |
| unit | messenger: telegram-provider > listChats returns chats that match Chat schema | 1.1ms | 1.4ms | +0.2ms |
| unit | ci: smogcheck-provider > fetchPR returns PR info that matches PRInfo schema | 1.3ms | 1.4ms | +0.0ms |
| unit | issue-tracker: smogcheck-provider > downloadResources downloads resources with distance <= 2 | 1.0ms | 1.1ms | +0.1ms |
| unit | issue-tracker: smogcheck-provider > downloadResources creates resources.json with correct metadata | 1.0ms | 1.1ms | +0.1ms |
| unit | issue-tracker: smogcheck-provider > downloadResources creates PR directories when PRs exist | 0.9ms | 1.0ms | +0.1ms |
| unit | issue-tracker: smogcheck-provider > downloadResources tracks resources with distance == 3 without downloading | 1.0ms | 0.9ms | -0.1ms |
| unit | messenger: telegram-provider > downloadFile returns a descriptor that matches DownloadFileResult schema | 0.7ms | 0.9ms | +0.1ms |
| unit | mcp: API module > mcpRouter is defined and has procedures | 0.8ms | 0.8ms | +0.0ms |
| unit | messenger: yandex-messenger-provider > downloadFile returns a descriptor that matches DownloadFileResult schema | 0.5ms | 0.7ms | +0.2ms |
| unit | workspace-path resolver > parses ark:/ links as Arcadia links | 0.5ms | 0.6ms | +0.1ms |
| unit | messenger: yandex-messenger-provider > listChats returns chats that match Chat schema | 0.5ms | 0.6ms | +0.1ms |
| unit | email: smogcheck-provider > matches EmailProvider interface | 0.5ms | 0.5ms | +0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchIssue returns issue that matches Issue schema | 0.5ms | 0.5ms | +0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchComments returns comments that match Comment schema | 0.4ms | 0.4ms | +0.0ms |
| unit | email: gmail-provider > matches EmailProvider interface | 0.4ms | 0.4ms | +0.0ms |
| unit | mcp: API module > mcpRouter.call procedure exists with correct schema | 0.2ms | 0.4ms | +0.1ms |
| unit | ci: smogcheck-provider > fetchCheckStatus returns check statuses that match CheckStatus schema | 0.5ms | 0.4ms | -0.2ms |
| unit | ci: smogcheck-provider > fetchComments returns comments that match Comment schema | 1.4ms | 0.3ms | -1.2ms |
| unit | workspace-path resolver > resolves ark:/ links using arc root (fallback to arc root) | 0.3ms | 0.3ms | +0.0ms |
| unit | email: smogcheck-provider > getMessage returns a message by id | 0.2ms | 0.3ms | +0.0ms |
| unit | mcp: API module > mcp.list can list servers when mcp.json exists | 0.2ms | 0.3ms | +0.0ms |
| unit | messenger: yandex-messenger-provider > matches MessengerProvider contract schema | 0.2ms | 0.3ms | +0.0ms |
| unit | mcp: API module > mcpRouter.list procedure exists with correct schema | 0.2ms | 0.2ms | +0.0ms |
| unit | email: smogcheck-provider > downloadAttachment returns a Buffer for an existing attachment | 0.2ms | 0.2ms | +0.0ms |
| unit | mcp: API module > mcp.call can be called via API CLI (help check) | 0.2ms | 0.2ms | +0.1ms |
| unit | ci: smogcheck-provider > fetchPR works with branch name | 0.2ms | 0.2ms | -0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchPRs returns empty array for issue without PRs | 0.1ms | 0.2ms | +0.1ms |
| unit | issue-tracker: smogcheck-provider > fetchPRs returns PR references that match PRReference schema | 0.2ms | 0.2ms | +0.0ms |
| unit | mcp: API module > npm run api lists mcp methods | 0.2ms | 0.2ms | -0.0ms |
| unit | mcp: API module > mcp.list can be called via API CLI | 0.1ms | 0.2ms | +0.0ms |
| unit | ci: smogcheck-provider > fetchComments includes reactions | 0.2ms | 0.2ms | -0.1ms |
| unit | issue-tracker: smogcheck-provider > fetchIssue works with URL | 0.1ms | 0.2ms | +0.0ms |
| unit | email: smogcheck-provider > searchMessages supports filtering by from | 0.2ms | 0.1ms | -0.0ms |
| unit | email: smogcheck-provider > searchMessages supports filtering by participant (to/cc/bcc/from) | 0.1ms | 0.1ms | -0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchIssue throws error for non-existent issue | 0.1ms | 0.1ms | -0.0ms |
| unit | ci: smogcheck-provider > fetchPR throws error for non-existent PR | 0.1ms | 0.1ms | -0.0ms |
| unit | workspace-path resolver > resolves ark:/ links using arc root and strips arcadia/ prefix | 0.8ms | 0.1ms | -0.7ms |
| unit | ci: smogcheck-provider > fetchComments includes file location for file comments | 0.1ms | 0.1ms | +0.0ms |
| unit | ci: smogcheck-provider > fetchCheckStatus returns annotations for failed checks | 0.1ms | 0.1ms | -0.0ms |
| unit | email: smogcheck-provider > searchMessages supports filtering by date range | 0.2ms | 0.1ms | -0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchComments includes reactions | 0.1ms | 0.1ms | -0.0ms |
| unit | issue-tracker-github: github-provider > downloadResources creates issue.json with comments | 0.1ms | 0.1ms | -0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchIssue works with issue key | 0.1ms | 0.1ms | +0.0ms |
| unit | issue-tracker: smogcheck-provider > fetchComments returns empty array for issue without comments | 0.1ms | 0.1ms | +0.0ms |
| unit | workspace-path resolver > if arc root is unavailable, ark:/ falls back to projectRoot | 0.1ms | 0.1ms | -0.1ms |
| unit | ci: smogcheck-provider > fetchCheckStatus works with checkId | 0.1ms | 0.1ms | -0.0ms |
| unit | issue-tracker-github: github-provider > downloadResources downloads resources with distance <= 1 | 0.1ms | 0.1ms | +0.0ms |
| unit | issue-tracker-github: github-provider > fetchIssue returns issue that matches Issue schema | 0.1ms | 0.1ms | -0.0ms |
| unit | ci: smogcheck-provider > fetchCheckStatus works with branch name | 0.1ms | 0.1ms | -0.0ms |
| unit | issue-tracker-github: github-provider > fetchComments returns comments that match Comment schema | 0.1ms | 0.1ms | +0.0ms |
| unit | issue-tracker-github: github-provider > downloadResources creates resources.json with correct metadata | 0.0ms | 0.1ms | +0.0ms |
| unit | issue-tracker-github: github-provider > fetchIssue works with URL | 0.1ms | 0.1ms | +0.0ms |
| unit | issue-tracker-github: github-provider > fetchPRs returns PR references that match PRReference schema | 0.0ms | 0.1ms | +0.0ms |
| unit | ci: smogcheck-provider > fetchComments works with branch name | 0.1ms | 0.1ms | -0.0ms |
| unit | issue-tracker-github: github-provider > fetchIssue throws error for non-existent issue | 0.0ms | 0.0ms | +0.0ms |
| unit | issue-tracker-github: github-provider > downloadResources creates correct directory structure | 0.0ms | 0.0ms | +0.0ms |

## 6. Final Report

### What changed

- Reduced unit test runner overhead by avoiding `npx` (`src/run-tests.ts`).
- Reduced installer test time by:
  - Removing redundant post-install polling waits.
  - Sharing a single workspace for the stateful ‚ÄúExisting Workspace Operations‚Äù installer tests.
  - Running cursor-free installer tests in-process (and keeping cursor-enabled runs in a subprocess for correctness).
- Made the Cursor API validity probe bounded by short curl timeouts (`extensions/cursor/MODULE.md`).
- Added a small helper script to print a per-test timing comparison table: `scripts/perf/print-test-timings-table.ts`.

### How to verify

- Run unit tests:
  - `npm run test:unit`
- Run Playwright installer tests:
  - `npm run test:installer:pw`
- (Optional) Re-generate the timing table (paths are from this run):
  - `tsx scripts/perf/print-test-timings-table.ts --baseline-unit .cache/baseline-unit.json --current-unit .cache/current-unit.json --baseline-pw .cache/baseline-pw.json --current-pw .cache/current-pw.json`

### Risks / Follow-ups

- `runInstallerInProcess(...)` intentionally falls back to the subprocess runner for cursor-enabled installs due to sync child processes blocking the event loop (mock server would not respond). If the installer‚Äôs check execution becomes async in the future, this fallback could be removed for additional speedups.

