# Pull Request

Create or update a Pull Request for the current branch. The script outputs structured information for AI agent to review and execute actions.

Usage: `node scripts/pr.js [-y|--yes] [git|arc]`

## Options

- `-y`, `--yes` — Auto-create PR / push without asking for confirmation (only if no warnings detected and there are no uncommitted changes)
- `git` — Create PR plan only for Git repositories (GitHub, etc.)
- `arc` — Create PR plan only for Arcadia repositories

## Safety rules (must follow)

- **Model requirement**: any operation that can create or modify commits/PRs (commit, push, PR create, PR description update) must be performed using the **most powerful available model**. **Currently: GPT-5.2**.
- **No write operations without explicit approval**:
  - When the user runs `/pr` **without** `-y`, the agent must do **analysis only** and then **ask to continue** before running any write commands.
  - The agent may run write commands **only** if:
    - The user ran `/pr -y` (or `node scripts/pr.js -y`) **and** the analysis output indicates `autoCreatePR: true` / `autoPush: true`, **or**
    - The user explicitly approved the action in chat (e.g. “yes, proceed”, “go ahead and create PR”, “push and create PR”).
- **Write commands include** (non-exhaustive): `arc add`, `arc commit`, `arc push`, `arc pr create`
- **Strict rule for `/pr` (without `-y`)**:
  - Before the PR plan is approved, the agent may only perform **analysis** and may offer to **commit** local changes.
  - **Push / PR create / PR description update are forbidden before plan approval.**
  - If the agent asks `commit? (y/n)` during `/pr`, answering `y` means **commit only**. Push must happen only after the user approves the plan with `ok` / `approve` / `продолжай`.

## Workflow

The AI agent should follow this workflow:

### 1. Run the PR analysis script
Execute `node scripts/pr.js` to get the current state.

**Repository filtering:**
- Use `node scripts/pr.js git` to create PR plan only for Git repositories
- Use `node scripts/pr.js arc` to create PR plan only for Arcadia repositories
- Use `node scripts/pr.js` (no filter) to create PR plan for all repositories

### 2. Handle uncommitted changes
If there are uncommitted changes:
- Ask `commit? (y/n)` and if approved use the `/commit` command to commit them first (**commit only; no push**)
- Then run `/pr` again

### 3. Generate a PR plan file and pause for review
If the user wants to **create a PR** or **update an existing PR**, after the analysis step (and before any write actions like push/create/update) the AI must:

- Generate a plan file at: `.cache/pr/<pr-name>.plan.md`
  - `<pr-name>`: a safe name (e.g. current branch name, or PR id/short title), without spaces and `/` (replace with `-`).
- Use this template as a reference: `templates/pr.plan.md`
- Fill the plan:
  - The plan MUST strictly follow the template structure (treat `templates/pr.plan.md` as a contract).
  - **Plan structure for multi-repository workspaces:**
    - First line: summary indicating how many PRs will be created (e.g., "You are going to create N PR(s) in: repo1, repo2, ...")
    - For each repository that will have a PR:
      - Section header: `## PR N: Repository Name (Git/Arcadia)`
      - Branch information: `**Branch**: branch-name`
      - Repository information: `**Repository**: repo-name`
      - PR Description section with:
        - short intro paragraph
        - icon-only bullet list (Feature/Bugfix/Refactor/Cleanup/Tests/Docs)
    - After all PR descriptions: AI Suggestions sections (Documentation, Unreachable Code Cleanup, Recipes)
    - Finally: Warnings section (if any warnings exist)
  - **Repository grouping rules:**
    - Each Git repository gets its own separate PR
    - All Arcadia changes are grouped into a single PR (regardless of which files changed)
    - The plan must list ALL PRs that will be created
  - The plan MUST NOT include extra technical sections (e.g. `## Changed Files`, `## Affected Areas`, commit lists).
  - The plan may include up to 3 additional sections only:
    - `AI Suggestions — Documentation`
    - `AI Suggestions — Unreachable Code Cleanup`
    - `AI Suggestions — Recipes`
  - The plan may include `## Warnings` section if there are any warnings.
- After generating the plan file, the AI must **open it in the IDE** and ask the user to:
  - check the relevant checkboxes,
  - and explicitly approve continuing work on the PR via chat message (`ok` / `approve` / `продолжай`).

Important:
- Plan generation requires **diff vs trunk** (via `arc diff trunk`). If diff is unavailable, the AI must stop and surface the `diff_unavailable` warning, asking to remount Arcadia working copy and rerun `/pr`.

Next:
- If **no additional code changes are needed** — proceed with PR creation/update.
- If the plan requires **additional code changes** — implement them, then suggest running `/pr` again.

### 4 Inform the user about next steps, autogenerated PR description and ask to continue
If `autoCreatePR: true` (when `-y` passed and no warnings) — AI agent can create PR without asking the user.
Otherwise — the agent must stop and ask for explicit user approval before running any write commands. User may approve with `y`, `ok`, `approve`, `yes`

### 5. Push changes to remote
If there are unpushed commits:
- Execute `arc push` to push commits to remote (**only after plan approval**)
- Wait for push to complete

### 6. Create or update PR
- If NO PR exists: Create with PR with generated description
- If PR exists: Just update the description for PR **from the plan file**:

The plan file is the single source of truth:
- PR title is taken from the first line (`# ...`)
- PR description is taken from `## PR Description` block only


```bash
set -a
source .env
set +a

node scripts/pr.js --update-description --from-plan ".cache/pr/<pr-name>.plan.md" --archive-plan
```

## Important Notes

- The script does NOT execute any actions automatically
- AI agent should review the output and ask for user confirmation
- Always handle uncommitted changes first via `/commit`
- For new PR if the current package version < 0.1.0 than increace the `bugfix` part of version in package.json
- **CRITICAL**: A repeated call to `/pr` command **NEVER** means plan approval. It means the plan must be **regenerated**. Plan approval happens only through explicit user message: `ok`, `approve`, `продолжай`, `yes`.

After successful PR create/update:
- move the current plan file to `.cache/trash/` and append timestamp to the filename (done by `--archive-plan`)
- always show the PR URL in the output (e.g. `https://a.yandex-team.ru/review/<id>`)

