name: PR - Tests & Metrics

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Don't run heavy tests/metrics workflow for docs-only PRs.
    paths-ignore:
      - "docs/**"

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  # Avoid referencing github.event.pull_request on push events (can be null).
  group: pr-ci-metrics-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # Create artifact folders BEFORE any potentially failing steps
      - name: Prepare artifact folders
        run: mkdir -p .cache/{logs,metrics,ai_logs,playwright,tmp}

      - name: Find existing PR metrics comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "<!-- barducks-metrics-comment -->"

      - name: Save previous metrics comment body (if exists)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.find_comment.outputs.comment-id != ''
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENT_ID: ${{ steps.find_comment.outputs.comment-id }}
        run: |
          set -euo pipefail
          api="${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/issues/comments/${COMMENT_ID}"
          curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "${api}" | jq -r '.body // ""' > .cache/metrics/previous-pr-comment.md

      - name: Render PR metrics comment (BUILDING/REBUILDING)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          node scripts/ci/render-pr-comment-dashboard.mjs \
            --dir .cache/metrics \
            --out .cache/metrics/pr-comment.status.md \
            --status "${{ steps.find_comment.outputs.comment-id != '' && 'rebuilding' || 'building' }}" \
            --existing .cache/metrics/previous-pr-comment.md

      - name: Update PR metrics comment (status)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.find_comment.outputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          body-path: .cache/metrics/pr-comment.status.md
          edit-mode: replace

      - name: Create PR metrics comment (status, first run)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.find_comment.outputs.comment-id == ''
        id: create_status_comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: .cache/metrics/pr-comment.status.md

      - name: Persist metrics comment id
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        shell: bash
        run: |
          set -euo pipefail
          cid="${{ steps.find_comment.outputs.comment-id }}"
          if [ -z "${cid}" ]; then cid="${{ steps.create_status_comment.outputs.comment-id }}"; fi
          echo "METRICS_COMMENT_ID=${cid}" >> "${GITHUB_ENV}"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      # Unit tests (run once, but don't stop artifact/metrics collection)
      - name: Run unit tests (timed)
        run: node scripts/ci/run-and-record.mjs --name npm_test --allow-failure 1 --cmd "bash -lc 'npx c8 --reporter=json-summary --report-dir .cache/coverage npm run test:unit || (echo \"⚠️ Unit tests failed, retrying after 60 seconds...\"; sleep 60; npx c8 --reporter=json-summary --report-dir .cache/coverage npm run test:unit)'" --log .cache/logs/npm-test.log --out .cache/metrics/test-commands.json

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # E2E tests (installer suite). Keep artifacts for failures.
      - name: Run Playwright installer suite (timed)
        run: node scripts/ci/run-and-record.mjs --name pw_installer --allow-failure 1 --cmd "bash -lc 'npx playwright test -c tests/installer/playwright.config.ts || (echo \"⚠️ Playwright installer suite failed, retrying after 60 seconds...\"; sleep 60; npx playwright test -c tests/installer/playwright.config.ts)'" --log .cache/logs/pw-installer.log --out .cache/metrics/test-commands.json

      # Optional smoke suite (only makes sense when BASE_URL is provided).
      - name: Run Playwright smoke suite (timed)
        if: ${{ env.BASE_URL }}
        run: node scripts/ci/run-and-record.mjs --name pw_smoke --allow-failure 1 --cmd "bash -lc 'npx playwright test -c tests/smoke/playwright.config.ts || (echo \"⚠️ Playwright smoke suite failed, retrying after 60 seconds...\"; sleep 60; npx playwright test -c tests/smoke/playwright.config.ts)'" --log .cache/logs/pw-smoke.log --out .cache/metrics/test-commands.json

      - name: Collect Playwright artifacts into .cache
        if: ${{ always() }}
        run: |
          mkdir -p .cache/playwright
          cp -r test-results .cache/playwright/ 2>/dev/null || true
          cp -r playwright-report .cache/playwright/ 2>/dev/null || true
          cp -r blob-report .cache/playwright/ 2>/dev/null || true

      - name: Checkout gh-pages (baseline + history)
        if: ${{ always() }}
        id: ghpages
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1

      - name: Load baseline/history from gh-pages (if present)
        if: ${{ always() }}
        run: |
          mkdir -p .cache/metrics
          if [ -f "gh-pages/metrics/baseline.json" ]; then cp "gh-pages/metrics/baseline.json" ".cache/metrics/baseline.json"; else echo '{}' > ".cache/metrics/baseline.json"; fi
          if [ -f "gh-pages/metrics/history.json" ]; then cp "gh-pages/metrics/history.json" ".cache/metrics/history.json"; else echo '[]' > ".cache/metrics/history.json"; fi
          cp ".cache/metrics/baseline.json" ".cache/metrics/compare-baseline.json"

      - name: Collect current metrics (no tests)
        if: ${{ always() }}
        run: node scripts/ci/collect-metrics.mjs
        # Optional: plug in your project-specific commands later via workflow env:
        # - BUILD_COMMAND (e.g. "npm run build")
        # - BUILD_OUTPUT_DIR (e.g. "dist")
        # - DEV_COMMAND (e.g. "npm run dev")
        # - DEV_READY_REGEX (e.g. "listening|ready|started")
        # - DEV_TIMEOUT_MS (e.g. "8000")

      - name: Compare with baseline
        if: ${{ always() }}
        run: node scripts/ci/compare-metrics.mjs --dir .cache/metrics --baseline .cache/metrics/compare-baseline.json

      - name: Evaluate test result gate
        id: tests_gate
        continue-on-error: true
        run: node scripts/ci/assert-tests-passed.mjs --file .cache/metrics/test-commands.json --require npm_test --require pw_installer

      - name: Render PR metrics comment (ready)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.tests_gate.outcome == 'success'
        run: node scripts/ci/render-pr-comment-dashboard.mjs --dir .cache/metrics --out .cache/metrics/pr-comment.ready.md

      - name: Update PR metrics comment (ready)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.tests_gate.outcome == 'success' && env.METRICS_COMMENT_ID != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ env.METRICS_COMMENT_ID }}
          body-path: .cache/metrics/pr-comment.ready.md
          edit-mode: replace

      - name: Render PR metrics comment (FAIL)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.tests_gate.outcome != 'success'
        run: |
          node scripts/ci/render-pr-comment-dashboard.mjs \
            --dir .cache/metrics \
            --out .cache/metrics/pr-comment.fail.md \
            --status fail \
            --existing .cache/metrics/previous-pr-comment.md

      - name: Update PR metrics comment (FAIL)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.tests_gate.outcome != 'success' && env.METRICS_COMMENT_ID != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ env.METRICS_COMMENT_ID }}
          body-path: .cache/metrics/pr-comment.fail.md
          edit-mode: replace

      - name: Generate HTML dashboard (always)
        run: node scripts/ci/generate-metrics-report.mjs --metrics-dir .cache/metrics --out-dir .cache/metrics-pages

      - name: Upload metrics + artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics-artifacts
          path: |
            .cache/metrics
            .cache/logs
            .cache/playwright
            .cache/coverage
            .cache/ai_logs
            .cache/metrics-pages
          retention-days: 14

      - name: Fail workflow if tests failed
        if: ${{ always() && steps.tests_gate.outcome != 'success' }}
        run: node scripts/ci/assert-tests-passed.mjs --file .cache/metrics/test-commands.json --require npm_test --require pw_installer

      - name: Render PR metrics comment (FAIL - job failure)
        if: ${{ github.event_name == 'pull_request' && failure() && github.event.pull_request.head.repo.full_name == github.repository }}
        run: |
          node scripts/ci/render-pr-comment-dashboard.mjs \
            --dir .cache/metrics \
            --out .cache/metrics/pr-comment.fail-job.md \
            --status fail \
            --existing .cache/metrics/previous-pr-comment.md

      - name: Update PR metrics comment (FAIL - job failure)
        if: ${{ github.event_name == 'pull_request' && failure() && github.event.pull_request.head.repo.full_name == github.repository && env.METRICS_COMMENT_ID != '' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ env.METRICS_COMMENT_ID }}
          body-path: .cache/metrics/pr-comment.fail-job.md
          edit-mode: replace

