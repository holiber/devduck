name: PR Metrics & Artifacts

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff calculation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create .cache structure
        run: mkdir -p .cache/{logs,metrics,ai_logs,playwright,tmp}

      - name: Run metrics collector
        run: tsx scripts/ci/collect-metrics.ts
        continue-on-error: true

      - name: Add PR delta info to metrics
        run: |
          if [ -f .cache/metrics/metrics.json ]; then
            jq ". + { 
              pr_number: ${{ github.event.pull_request.number }}, 
              pr_additions: ${{ github.event.pull_request.additions }}, 
              pr_deletions: ${{ github.event.pull_request.deletions }},
              pr_changed_files: ${{ github.event.pull_request.changed_files }},
              pr_title: \"${{ github.event.pull_request.title }}\",
              pr_author: \"${{ github.event.pull_request.user.login }}\",
              commit_sha: \"${{ github.event.pull_request.head.sha }}\"
            }" .cache/metrics/metrics.json > .cache/metrics/tmp.json
            mv .cache/metrics/tmp.json .cache/metrics/metrics.json
          fi

      - name: Run Playwright tests
        run: npm run test:pw
        continue-on-error: true

      - name: Collect Playwright artifacts
        if: always()
        run: |
          # Copy test results
          if [ -d "test-results" ]; then
            cp -r test-results .cache/playwright/ || true
          fi
          
          # Copy playwright report
          if [ -d "playwright-report" ]; then
            cp -r playwright-report .cache/playwright/ || true
          fi
          
          # Copy blob report if exists
          if [ -d "blob-report" ]; then
            cp -r blob-report .cache/playwright/ || true
          fi
          
          # Create summary of failed tests
          if [ -d "test-results" ]; then
            echo "# Playwright Test Results" > .cache/playwright/summary.md
            echo "" >> .cache/playwright/summary.md
            echo "## Failed Tests" >> .cache/playwright/summary.md
            find test-results -name "*.png" -o -name "*.webm" | head -20 | while read file; do
              echo "- $file" >> .cache/playwright/summary.md
            done
          fi

      - name: Save AI agent logs
        run: |
          tsx scripts/ci/ai-logger.ts simple-log "cursor-ai" "PR ${{ github.event.pull_request.number }} analysis complete" "{\"pr_number\":${{ github.event.pull_request.number }},\"workflow\":\"pr-metrics\",\"run_id\":\"${{ github.run_id }}\"}"

      - name: Generate metrics summary
        if: always()
        run: |
          if [ -f .cache/metrics/metrics.json ]; then
            echo "# Metrics Summary" > .cache/metrics/summary.md
            echo "" >> .cache/metrics/summary.md
            
            # Extract and format metrics
            TEST_TIME=$(jq -r '.test_time_sec // "N/A"' .cache/metrics/metrics.json)
            BUILD_TIME=$(jq -r '.build_time_sec // "N/A"' .cache/metrics/metrics.json)
            BUNDLE_SIZE=$(jq -r '.bundle_size_bytes // 0' .cache/metrics/metrics.json)
            ADDITIONS=$(jq -r '.pr_additions // .code_additions // 0' .cache/metrics/metrics.json)
            DELETIONS=$(jq -r '.pr_deletions // .code_deletions // 0' .cache/metrics/metrics.json)
            
            # Convert bundle size to human readable
            if [ "$BUNDLE_SIZE" != "0" ] && [ "$BUNDLE_SIZE" != "null" ]; then
              BUNDLE_SIZE_KB=$(echo "scale=2; $BUNDLE_SIZE / 1024" | bc)
              BUNDLE_SIZE_STR="${BUNDLE_SIZE_KB} KB"
            else
              BUNDLE_SIZE_STR="N/A"
            fi
            
            echo "**Test Time:** ${TEST_TIME}s" >> .cache/metrics/summary.md
            echo "**Build Time:** ${BUILD_TIME}s" >> .cache/metrics/summary.md
            echo "**Bundle Size:** ${BUNDLE_SIZE_STR}" >> .cache/metrics/summary.md
            echo "**Code Changes:** +${ADDITIONS} / -${DELETIONS}" >> .cache/metrics/summary.md
          fi

      - name: Upload all artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-metrics-artifacts-${{ github.event.pull_request.number }}
          path: |
            .cache/logs/**/*
            .cache/metrics/**/*
            .cache/ai_logs/**/*
            .cache/playwright/**/*
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Playwright trace on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-${{ github.event.pull_request.number }}
          path: test-results/**/trace.zip
          retention-days: 14
          if-no-files-found: ignore

  comment:
    runs-on: ubuntu-latest
    needs: metrics
    if: always()

    steps:
      - name: Download metrics
        uses: actions/download-artifact@v4
        with:
          name: pr-metrics-artifacts-${{ github.event.pull_request.number }}
          path: .cache

      - name: Prepare comment body
        id: prepare-comment
        run: |
          # Start building the comment
          COMMENT_BODY="### ðŸ§  PR Metrics Summary

          "
          
          if [ -f .cache/metrics/metrics.json ]; then
            # Extract metrics
            TEST_TIME=$(jq -r '.test_time_sec // "N/A"' .cache/metrics/metrics.json)
            BUILD_TIME=$(jq -r '.build_time_sec // "N/A"' .cache/metrics/metrics.json)
            BUNDLE_SIZE=$(jq -r '.bundle_size_bytes // 0' .cache/metrics/metrics.json)
            ADDITIONS=$(jq -r '.pr_additions // .code_additions // 0' .cache/metrics/metrics.json)
            DELETIONS=$(jq -r '.pr_deletions // .code_deletions // 0' .cache/metrics/metrics.json)
            TEST_PASSED=$(jq -r '.test_passed // 0' .cache/metrics/metrics.json)
            TEST_FAILED=$(jq -r '.test_failed // 0' .cache/metrics/metrics.json)
            
            # Format bundle size
            if [ "$BUNDLE_SIZE" != "0" ] && [ "$BUNDLE_SIZE" != "null" ]; then
              BUNDLE_SIZE_KB=$(echo "scale=2; $BUNDLE_SIZE / 1024" | bc)
              BUNDLE_SIZE_STR="${BUNDLE_SIZE_KB} KB"
            else
              BUNDLE_SIZE_STR="N/A"
            fi
            
            # Format test time
            if [ "$TEST_TIME" != "N/A" ] && [ "$TEST_TIME" != "null" ]; then
              TEST_TIME_STR="${TEST_TIME}s"
            else
              TEST_TIME_STR="N/A"
            fi
            
            # Format build time
            if [ "$BUILD_TIME" != "N/A" ] && [ "$BUILD_TIME" != "null" ]; then
              BUILD_TIME_STR="${BUILD_TIME}s"
            else
              BUILD_TIME_STR="N/A"
            fi
            
            COMMENT_BODY+="
          | Metric | Value |
          |--------|-------|
          | ðŸ“Š **Code Changes** | +${ADDITIONS} / -${DELETIONS} |
          | ðŸ§ª **Test Time** | ${TEST_TIME_STR} |
          | ðŸ“¦ **Build Time** | ${BUILD_TIME_STR} |
          | ðŸ“ **Bundle Size** | ${BUNDLE_SIZE_STR} |
          | âœ… **Tests Passed** | ${TEST_PASSED} |
          | âŒ **Tests Failed** | ${TEST_FAILED} |

          "
          
            # Check for errors
            ERRORS=$(jq -r '.errors // [] | length' .cache/metrics/metrics.json)
            if [ "$ERRORS" != "0" ]; then
              COMMENT_BODY+="
          âš ï¸ **Warning:** Some metrics collection steps encountered errors. Check the logs for details.

          "
            fi
          else
            COMMENT_BODY+="âš ï¸ Metrics file not found. The collection may have failed.

          "
          fi
          
          # Add Playwright info if available
          if [ -f .cache/playwright/summary.md ]; then
            COMMENT_BODY+="
          ### ðŸŽ­ Playwright Tests

          "
            COMMENT_BODY+="$(cat .cache/playwright/summary.md)

          "
          fi
          
          COMMENT_BODY+="
          ---
          ðŸ§© **Artifacts:** Logs, screenshots, videos, and AI logs are available in [workflow artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          
          ðŸ“ˆ **Full Report:** [View detailed metrics](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "
          
          # Save to file for the next step
          echo "$COMMENT_BODY" > /tmp/comment-body.txt

      - name: Comment PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: /tmp/comment-body.txt
          edit-mode: replace
