name: PR Metrics & Artifacts

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-metrics-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Create .cache structure
        run: mkdir -p .cache/{logs,metrics,ai_logs,playwright,tmp}

      # Best-effort: this script runs installs, tests, Playwright suites, and produces `.cache/metrics/metrics.json`.
      - name: Collect metrics (best-effort)
        run: node scripts/ci/collect-pr-metrics.mjs
        env:
          # Smoke tests require a reachable app under BASE_URL; by default they're skipped if BASE_URL is missing.
          PLAYWRIGHT_INSTALLER_CONFIG: tests/installer/playwright.config.ts
          PLAYWRIGHT_SMOKE_CONFIG: tests/smoke/playwright.config.ts

          # Optional: plug in your project-specific commands later:
          # BUILD_COMMAND: npm run build
          # BUILD_OUTPUT_DIR: dist
          # DEV_COMMAND: npm run dev
          # DEV_READY_REGEX: "listening|ready|started"
          # DEV_TIMEOUT_MS: "8000"

      - name: Upload PR metrics artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-metrics-artifacts
          path: |
            .cache/logs
            .cache/metrics
            .cache/ai_logs
            .cache/playwright
          retention-days: 14

  comment:
    runs-on: ubuntu-latest
    needs: metrics
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Download PR metrics artifacts
        uses: actions/download-artifact@v4
        with:
          name: pr-metrics-artifacts
          path: .cache

      - name: Render PR comment
        run: node scripts/ci/render-pr-comment.mjs --metrics .cache/metrics/metrics.json --out .cache/metrics/pr-comment.md

      - name: Comment PR (create or update)
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: .cache/metrics/pr-comment.md

