# Workspace Config Baseline and Extends Implementation

## Summary

This implementation adds a workspace config inheritance system with a baseline configuration and extends resolution, making the workspace config the source of truth for Taskfile generation.

## Changes Implemented

### 1. Baseline Configuration (`/workspace/defaults/workspace.install.yml`)

Created a baseline workspace config that defines canonical install tasks and variables:
- **taskfile.vars**: `CACHE_DIR`, `ARTIFACTS_DIR`
- **taskfile.tasks**: `install` and `install:1-7` steps that call `run-step.ts`

This baseline can be extended by any DevDuck workspace using `devduck:defaults/workspace.install.yml`.

### 2. Extends Resolution (`/workspace/scripts/lib/workspace-config.ts`)

Implemented a complete config inheritance system:

**Features:**
- Parse `extends: string[]` from workspace configs
- Support `devduck:` prefix for paths relative to `devduck_path`
- Merge order: base → ... → workspace (later configs override earlier ones)
- Merge semantics:
  - **Objects**: Deep merge
  - **Arrays**: Concat + dedupe by key
    - `projects`: dedupe by `src`
    - `checks`/`env`: dedupe by `name`
    - Other arrays: dedupe by JSON stringification
- **Cycle detection**: Detects and reports circular extends chains
- **Error handling**: Clear error messages for missing files

**New Functions:**
- `readWorkspaceConfigFileWithExtends()`: Load config with extends resolution
- `resolveConfigPath()`: Resolve `devduck:` prefix and relative paths
- `deepMerge()`: Deep merge with array concat+dedupe
- `dedupeArray()`: Deduplicate arrays based on type

**API Changes:**
- `readWorkspaceConfigFromRoot()` now accepts `{ withExtends?: boolean }` option (default: true)

### 3. Schema Updates (`/workspace/scripts/schemas/workspace-config.zod.ts`)

Extended the workspace config schema:
- Added `extends?: string[]` field for config inheritance
- Added `taskfile?: { vars, tasks }` field for Taskfile generation
- Added `WorkspaceTaskfileSchema` and `TaskfileTaskSchema`
- Exported TypeScript types: `WorkspaceConfig`, `WorkspaceTaskfile`, `TaskfileTask`

### 4. Taskfile Generation Updates

Updated both taskfile generation functions to use merged config:

**`scripts/devduck-cli.ts` (sync command):**
- Modified `buildGeneratedTaskfile()` to accept config parameter
- Use merged config's `taskfile` section if present
- Fall back to hardcoded defaults for backward compatibility
- Always inject `DEVDUCK_ROOT` and `WORKSPACE_ROOT` vars

**`scripts/install/workspace-install.ts`:**
- Modified `buildGeneratedTaskfile()` similarly
- Load merged config with extends before generating taskfile
- Ensure injected vars override any from config

### 5. This Repo's Workspace Config (`/workspace/workspace.config.yml`)

Created workspace config for this repository:
- Extends from `devduck:defaults/workspace.install.yml`
- Sets `devduck_path: "."` (this repo IS DevDuck)
- Includes core modules: `core`, `cursor`

### 6. Test Coverage

Created comprehensive test suite in `tests/workspace-config/`:

**`extends.test.ts` (11 tests):**
- Loading configs with/without extends
- Relative path resolution
- `devduck:` prefix resolution
- Deep merge of objects
- Concat+dedupe of arrays (projects, checks, env)
- Multiple extends chain
- Circular dependency detection
- Missing file error handling
- Extends field removal from final config

**`taskfile-generation.test.ts` (4 tests):**
- Generating taskfile with merged config
- Fallback to hardcoded tasks
- Injected vars verification
- Workspace vars override baseline vars

**Test Results:** All 15 tests passing ✅

## Usage Example

### Creating a DevDuck Workspace

```yaml
# workspace.config.yml
version: "0.1.0"

# Extend from DevDuck baseline
extends:
  - "devduck:defaults/workspace.install.yml"

devduck_path: "./devduck/src"

modules:
  - core
  - cursor

# Optional: Override or add taskfile vars
taskfile:
  vars:
    CUSTOM_VAR: "my-value"
```

### Custom Install Steps

Workspaces can override install tasks by defining their own `taskfile.tasks`:

```yaml
extends:
  - "devduck:defaults/workspace.install.yml"

taskfile:
  tasks:
    install:
      desc: "Custom install sequence"
      cmds:
        - task: install:1-check-env
        - task: custom-step
        - task: install:7-verify-installation
    
    custom-step:
      desc: "My custom installation step"
      cmds:
        - echo "Running custom step"
```

## Generated Output

Running `devduck sync` generates `.cache/taskfile.generated.yml`:

```yaml
version: "3"
output: interleaved
vars:
  CACHE_DIR: .cache
  ARTIFACTS_DIR: "{{.CACHE_DIR}}/artifacts"
  DEVDUCK_ROOT: .
  WORKSPACE_ROOT: '{{ default "." .WORKSPACE_ROOT }}'
tasks:
  install:
    desc: Run full installation sequence (Steps 1–7)
    cmds: [...]
  install:1-check-env:
    desc: Verify required environment variables
    cmds: [...]
  # ... install:2-7 tasks
```

## Backward Compatibility

- Configs without `extends` work unchanged
- Configs without `taskfile` section fall back to hardcoded defaults
- `readWorkspaceConfigFromRoot()` has `withExtends: true` by default, but can be disabled
- All existing tests continue to pass

## Benefits

1. **DRY**: No more duplicate task definitions across workspaces
2. **Maintainability**: Update install steps in one place (baseline config)
3. **Flexibility**: Workspaces can extend, override, or fully customize
4. **Type Safety**: Zod schemas validate config structure
5. **Testing**: Comprehensive test coverage ensures reliability
6. **Error Handling**: Clear error messages for config issues
